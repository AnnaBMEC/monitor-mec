<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Or√ßament√°rio MEC - Oficial</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #003366; border-bottom: 3px solid #ffd700; padding-bottom: 10px; margin-bottom: 25px; }
        
        /* Gr√°fico */
        .grafico-box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 30px; height: 350px; }
        
        /* Notifica√ß√£o */
        #alert-box { display: none; background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }

        .links-rapidos { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .btn { padding: 12px 20px; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; font-size: 0.85rem; transition: 0.3s; border: none; cursor: pointer; }
        .btn-sei { background: #721c24; }
        .btn-siop { background: #155724; }
        .btn-camara { background: #004a8d; }

        .busca-bloco { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #004a8d; display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #003366; color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .foto-dep { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #004a8d; margin-right: 15px; }
        .flex-cell { display: flex; align-items: center; }
        .badge-uf { background: #eee; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div id="alert-box">üîî Dados atualizados com sucesso via API da Transpar√™ncia.</div>

<div class="container">
    <h1>üèõÔ∏è Centro de Gest√£o Or√ßament√°ria MEC (2024-2026)</h1>

    <div class="links-rapidos">
        <a href="https://sei.mec.gov.br/" target="_blank" class="btn btn-sei">SEI MEC</a>
        <a href="https://www.siop.planejamento.gov.br/" target="_blank" class="btn btn-siop">SIOP</a>
        <button onclick="location.reload()" class="btn" style="background:#6c757d">üîÑ Sincronizar Agora</button>
    </div>

    <div class="grafico-box">
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="busca-bloco">
        <input type="text" id="filtro" placeholder="Pesquisar Parlamentar, Estado ou Partido..." onkeyup="filtrarTabela()">
        <input type="text" id="numEmenda" placeholder="N¬∫ Emenda (ex: 12340005)" style="max-width: 180px;">
        <button onclick="buscarEmenda()" class="btn btn-camara">Localizar</button>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Parlamentar / Foto</th>
                <th>Dados Pol√≠ticos</th>
                <th>Consultas Detalhadas</th>
            </tr>
        </thead>
        <tbody id="lista-corpo">
            <tr><td colspan="3" style="text-align:center">Conectando aos Dados Abertos...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const CHAVE = "2e820c7589765e7414b397836e6d1976";
    const ORGAO = "26000";
    let chart;

    // Fun√ß√£o para converter valores da API
    const parseValor = (v) => v ? parseFloat(v.replace(/\./g, '').replace(',', '.')) : 0;

    async function buscarValoresAno(ano) {
        const url = `https://api.portaldatransparencia.gov.br/api-de-dados/emendas?codigoOrgao=${ORGAO}&ano=${ano}&pagina=1`;
        try {
            const r = await fetch(url, { headers: { "chave-api-dados": CHAVE } });
            const dados = await r.json();
            return dados.reduce((acc, curr) => acc + parseValor(curr.valorEmpenhado), 0);
        } catch { return 0; }
    }

    async function init() {
        // Carregar Gr√°fico com Dados Reais
        const [v24, v25, v26] = await Promise.all([buscarValoresAno(2024), buscarValoresAno(2025), buscarValoresAno(2026)]);
        
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Exerc√≠cio 2024', 'Exerc√≠cio 2025', 'Exerc√≠cio 2026'],
                datasets: [{
                    label: 'Total Empenhado MEC (R$)',
                    data: [v24, v25, v26],
                    backgroundColor: ['#34495e', '#3498db', '#2ecc71']
                }]
            },
            options: { maintainAspectRatio: false, responsive: true }
        });

        if (v26 > 0) document.getElementById('alert-box').style.display = 'block';

        // Carregar Tabela com Fotos
        const res = await fetch("https://dadosabertos.camara.leg.br/api/v2/deputados?ordem=ASC&ordenarPor=nome");
        const json = await res.json();
        const tbody = document.getElementById('lista-corpo');
        tbody.innerHTML = '';

        json.dados.forEach(d => {
            // URL corrigida: nome entre aspas e filtro de √≥rg√£o garantido
            const urlFinal = `https://portaldatransparencia.gov.br/emendas?ano=2026&orgao=${ORGAO}&nomeParlamentar=${encodeURIComponent('"' + d.nome + '"')}`;
            
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="flex-cell">
                            <img src="${d.urlFoto}" class="foto-dep" loading="lazy">
                            <strong>${d.nome}</strong>
                        </div>
                    </td>
                    <td><span class="badge-uf">${d.siglaUf}</span> ${d.siglaPartido}</td>
                    <td>
                        <a href="${urlFinal}" target="_blank" style="color:#004a8d; font-weight:bold; text-decoration:none;">üîé Emendas MEC 2026</a>
                    </td>
                </tr>`;
        });
    }

    function buscarEmenda() {
        const n = document.getElementById('numEmenda').value;
        if(n) window.open(`https://www.camara.leg.br/internet/deputado/RelData_Emendas.asp?numEmenda=${n}&ano=2026`, '_blank');
    }

    function filtrarTabela() {
        const val = document.getElementById("filtro").value.toUpperCase();
        const rows = document.querySelectorAll("#lista-corpo tr");
        rows.forEach(r => r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none");
    }

    window.onload = init;
</script>
</body>
</html>
