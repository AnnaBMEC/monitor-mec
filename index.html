<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Or√ßament√°rio MEC - Oficial</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #003366; border-bottom: 3px solid #ffd700; padding-bottom: 10px; margin-bottom: 25px; }
        .grafico-box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 30px; height: 350px; }
        .links-rapidos { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .btn { padding: 12px 20px; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; font-size: 0.85rem; transition: 0.3s; border: none; cursor: pointer; }
        .btn-sei { background: #721c24; }
        .btn-siop { background: #155724; }
        .btn-camara { background: #004a8d; }
        .busca-bloco { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #004a8d; display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #003366; color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .foto-dep { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #004a8d; margin-right: 15px; }
        .flex-cell { display: flex; align-items: center; }
        #status-api { padding: 10px; color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèõÔ∏è Centro de Gest√£o Or√ßament√°ria MEC</h1>

    <div class="links-rapidos">
        <a href="https://sei.mec.gov.br/" target="_blank" class="btn btn-sei">SEI MEC</a>
        <a href="https://www.siop.planejamento.gov.br/" target="_blank" class="btn btn-siop">SIOP</a>
        <button onclick="location.reload()" class="btn" style="background:#6c757d">üîÑ Sincronizar Dados</button>
    </div>

    <div class="grafico-box">
        <div id="status-api">Consultando valores nos servidores do Governo...</div>
        <canvas id="meuGrafico"></canvas>
    </div>

    <div class="busca-bloco">
        <input type="text" id="filtro" placeholder="Pesquisar Parlamentar, Estado ou Partido..." onkeyup="filtrarTabela()">
        <button onclick="buscarEmenda()" class="btn btn-camara">Localizar Emenda</button>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Parlamentar / Foto</th>
                <th>UF / Partido</th>
                <th>Consultas 2026</th>
            </tr>
        </thead>
        <tbody id="lista-corpo"></tbody>
    </table>
</div>

<script>
    const CHAVE = "2e820c7589765e7414b397836e6d1976";
    const ORGAO = "26000";

    // Fun√ß√£o para converter valores
    const parseValor = (v) => v ? parseFloat(v.replace(/\./g, '').replace(',', '.')) : 0;

    async function buscarValoresAno(ano) {
        // Usando o proxy AllOrigins para contornar o erro de carregamento (CORS)
        const urlOriginal = `https://api.portaldatransparencia.gov.br/api-de-dados/emendas?codigoOrgao=${ORGAO}&ano=${ano}&pagina=1`;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(urlOriginal)}`;

        try {
            const r = await fetch(proxyUrl);
            const resJson = await r.json();
            const dados = JSON.parse(resJson.contents); // O proxy traz o dado dentro de 'contents'
            
            return dados.reduce((acc, curr) => acc + parseValor(curr.valorEmpenhado), 0);
        } catch (e) { 
            console.error("Erro no ano " + ano, e);
            return 0; 
        }
    }

    async function init() {
        // 1. Carregar Tabela Primeiro (Mais r√°pido)
        const res = await fetch("https://dadosabertos.camara.leg.br/api/v2/deputados?ordem=ASC&ordenarPor=nome");
        const json = await res.json();
        const tbody = document.getElementById('lista-corpo');
        
        json.dados.forEach(d => {
            const urlFinal = `https://portaldatransparencia.gov.br/emendas?ano=2026&orgao=${ORGAO}&nomeParlamentar=${encodeURIComponent('"' + d.nome + '"')}`;
            tbody.innerHTML += `
                <tr>
                    <td><div class="flex-cell"><img src="${d.urlFoto}" class="foto-dep" loading="lazy"><strong>${d.nome}</strong></div></td>
                    <td>${d.siglaUf} / ${d.siglaPartido}</td>
                    <td><a href="${urlFinal}" target="_blank" style="color:#004a8d; font-weight:bold; text-decoration:none;">üîé Ver no Portal</a></td>
                </tr>`;
        });

        // 2. Carregar Gr√°fico com Proxy
        const [v24, v25, v26] = await Promise.all([buscarValoresAno(2024), buscarValoresAno(2025), buscarValoresAno(2026)]);
        
        document.getElementById('status-api').style.display = 'none';
        const ctx = document.getElementById('meuGrafico').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Exerc√≠cio 2024', 'Exerc√≠cio 2025', 'Exerc√≠cio 2026'],
                datasets: [{
                    label: 'Valores Empenhados MEC (R$)',
                    data: [v24, v25, v26],
                    backgroundColor: ['#34495e', '#3498db', '#2ecc71']
                }]
            },
            options: { maintainAspectRatio: false, responsive: true }
        });
    }

    function filtrarTabela() {
        const val = document.getElementById("filtro").value.toUpperCase();
        const rows = document.querySelectorAll("#lista-corpo tr");
        rows.forEach(r => r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none");
    }

    window.onload = init;
</script>
</body>
</html>
