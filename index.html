// --- INTEGRAÇÃO SIOP GRAPHQL ---

async function consultarSiop() {
    // 1. Configurações (Você precisará da URL real fornecida pela SOF)
    const SIOP_ENDPOINT = "https://url-do-servico-siop.gov.br/graphql"; 
    const token = document.getElementById('siop-token').value;
    const container = document.getElementById('resultado-siop');

    if (!token) {
        alert("Por favor, insira um Token de acesso válido.");
        return;
    }

    container.innerHTML = '<div style="text-align:center; padding:50px"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><br>Consultando SIOP ME/SOF...</div>';

    // 2. A Query GraphQL (Baseada na documentação que você enviou)
    // Estamos pedindo: ID, Código, Descrição e Valor das emendas de 2026
    const graphqlQuery = {
        query: `
            query BuscarEmendas {
                itens(filtro: { exercicio: 2026 }) {
                    id
                    codigo
                    descricao
                    valor
                    beneficiario {
                        nome
                        cnpj
                    }
                    situacao
                }
            }
        `
    };

    try {
        // 3. A Requisição POST
        const response = await fetch(SIOP_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`, // Autenticação obrigatória
                "Accept": "application/json"
            },
            body: JSON.stringify(graphqlQuery)
        });

        const json = await response.json();

        // 4. Tratamento de Erros da API
        if (json.errors) {
            container.innerHTML = `<div style="color:red"><strong>Erro na API:</strong> ${json.errors[0].message}</div>`;
            return;
        }

        // 5. Renderização dos Dados
        const itens = json.data.itens;
        
        if (itens.length === 0) {
            container.innerHTML = "<div>Nenhum item encontrado para este perfil.</div>";
            return;
        }

        let html = '<table style="width:100%; font-size:0.85rem;"><thead><tr><th>Cód</th><th>Descrição</th><th>Valor</th><th>Situação</th></tr></thead><tbody>';
        
        itens.forEach(item => {
            html += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px; font-weight:bold;">${item.codigo || item.id}</td>
                    <td style="padding:8px;">${item.descricao}</td>
                    <td style="padding:8px;">R$ ${parseFloat(item.valor).toLocaleString('pt-BR')}</td>
                    <td style="padding:8px;"><span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px;">${item.situacao || 'Ativo'}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;

    } catch (error) {
        console.error("Erro SIOP:", error);
        container.innerHTML = `
            <div style="color:red; text-align:center;">
                <strong>Falha na conexão</strong><br>
                Verifique se a URL do Endpoint está correta e se você tem permissão de rede (VPN/Proxy).
                <br><br>
                <em>Erro técnico: ${error.message}</em>
            </div>
        `;
    }
}
